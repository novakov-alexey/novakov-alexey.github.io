<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  
  
  
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https://novakov-alexey.github.io/site.css' rel="stylesheet" />

  
  

  <title>
    
Alexey Novakov Notes | ONNX Model format in Flink 

  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-49N5BCWL0F"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "G-49N5BCWL0F");
  </script>
  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="https:&#x2F;&#x2F;novakov-alexey.github.io">Alexey Novakov Notes</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;'>
            Blog
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;cv'>
            CV
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;presentations'>
            Presentations
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;tags'>
            Tags
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;categories'>
            Categories
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title is-1">
            ONNX Model format in Flink 
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
    Alexey Novakov published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2025-01-10'>January 10, 2025</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    7 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    1352 words
  </p>

            </div>
            <div class="column">
              
              
  <p>
    <span class="has-text-black has-text-weight-normal">Categories:</span>
    
      <a class="link has-text-weight-light" href='https://novakov-alexey.github.io/categories/scala/'>
        <span class="icon is-small">
          <i class="fas fa-folder fa-xs"></i>
        </span>
        scala
      </a>
    
  </p>

              
            </div>
            <div class="column has-text-right-desktop">
              
              
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https://novakov-alexey.github.io/tags/flink/'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        flink
      </a>
    
      <a class="link has-text-weight-light" href='https://novakov-alexey.github.io/tags/machine-learning/'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        machine learning
      </a>
    
      <a class="link has-text-weight-light" href='https://novakov-alexey.github.io/tags/scala/'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        scala
      </a>
    
      <a class="link has-text-weight-light" href='https://novakov-alexey.github.io/tags/tensorflow/'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        tensorflow
      </a>
    
      <a class="link has-text-weight-light" href='https://novakov-alexey.github.io/tags/onnx/'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        onnx
      </a>
    
  </p>

              
            </div>
          </div>
          <div class="content mt-2 has-text-justified">
            <p>The most popular eco-system to train ML model these days is Python and C/C++ based libraries. An example of model training can be a Logistic Regression algorithms, from ScikitLearn package or
more advanced neural networks algorithms offered by Tensorflow, Pytorch and others. There are lots of tools and libraries in Python world to facilitate training and model serving.</p>
<p>In order to bring trained models in Keras or SciKitLean into a Flink application, we can use cross-platform file formats such as ONNX and PMML (in the past). These formats also come with language runtimes.
In Flink case, we select JVM SDK to run inference logic inside the Flink job.</p>
<p>Let's look at the example on how to train Logistic Regression in Python using Keras and then use trained model in ONNX format inside Flink.</p>


<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;onnx-logo.89bbc982f155e9cd.png" class="center-image"/>
<br/><br/><span id="continue-reading"></span><h1 id="training-in-python">Training in Python</h1>
<p>We will use the same Machine Learning task of Custom Churn Analysis as we did in the first blog post "Machine Learning with Flink".</p>
<p>In order to train Logistic Regression algorithm in Python we will use Keras (part of Tensorflow library) to train simple Artificial Neural Network (ANN)
and store it to disk. Then, we will use <a href="https://pypi.org/project/tf2onnx/">tf2onnx</a> Python package to convert Tensorflow <a href="https://www.tensorflow.org/tutorials/keras/save_and_load#savedmodel_format">saved_model</a> to ONNX format.</p>
<p>We have already prepared Git repository to clone and get the trained ONNX model. Follow below instructions:</p>
<p>GitHub Repository: <a href="https://github.com/novakov-alexey/tf-onnx-customer-churn">https://github.com/novakov-alexey/tf-onnx-customer-churn</a></p>
<ol>
<li>Clone the Git repository.</li>
</ol>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">git</span><span> clone https://github.com/novakov-alexey/tf-onnx-customer-churn
</span></code></pre>
<ol start="2">
<li>Create Python environment via:</li>
</ol>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">make</span><span> create-env
</span></code></pre>
<ol start="3">
<li>Install Python packages via:</li>
</ol>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#616e88;"># if you are on MacOs
</span><span style="color:#88c0d0;">make</span><span> install-macos 
</span><span style="color:#616e88;"># or if you are on Linux
</span><span style="color:#88c0d0;">make</span><span> install-linux
</span></code></pre>
<ol start="3">
<li>Train and save model to disk via:</li>
</ol>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">python</span><span> artificial_neural_network.py
</span></code></pre>
<ol start="4">
<li>Finally, export into ONNX:</li>
</ol>
<pre data-lang="bash" style="background-color:#2e3440;color:#d8dee9;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#88c0d0;">make</span><span> onnx-export
</span></code></pre>
<p>In result, we get a model in the ONNX format under <code>models/model.onnx</code> file path. We will use it in the next step.</p>
<h1 id="inference-in-flink">Inference in Flink</h1>
<p>Now we are almost ready to use trained model and run inference for the live data.
However, there is one caveat in data preparation which we need take care of.</p>
<p>While training ANN in Python we encoded input raw data using SciKitLearn package: categorical features were one-hot encoded, then all columns were
scaled as per their mean and standard deviation. This data preparation logic is part of feature engineering and sometimes called as feature extraction.
We need either repeat this code in the Flink job or apply it somewhere in upstream data flow before the Flink job gets triggered.</p>
<p>To summarize the whole process we can describe end-to-end flow in the following way:</p>
<p><strong>Training Part</strong>:</p>


<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;training-in-python.f5dd2c88e698cf39.png" class="center-image"/>
<br/><br/><p align="center">Figure 1. Model training in Python</p>
<p><strong>Inference Part</strong>:</p>
<p><em>Option 1 - Feature extraction is implemented again:</em></p>
<p>In Option 1., we use own code inside the Flink job to transform raw data into feature vectors which we can feed directly into the ML model to get predictions.</p>


<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;inference-op-1.9029ef421c8a9549.png" class="center-image"/>
<br/><br/><p align="center">Figure 2. Data Preparation in Flink job itself</p>
<p><em>Option 2 - The same Python script acts as pre-processor:</em></p>
<p>In Option 2. we use the same code which was used during the training process. Python app is running as non-Flink app which prepares and stores data in the vector format.</p>


<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;inference-op-2.9c27e31769543d55.png" class="center-image"/>
<br/><br/><p align="center">Figure 3. Data Preparation in Python before the Flink job</p>
<p>As you can see we have to either duplicate feature extraction logic in Flink job (option 1.) or reuse a part of training Python script just to extract features
from live data and pass it further to the Flink job.</p>
<p>In this blog post we select <strong>Option 1.</strong> just demonstrate that standard feature extraction algorithm is
not hard to implement in Flink itself. Downside of this option is that we repeat ourselves which makes overall workflow maintenance
more labor intensive or even error-prone, if this logic is not synchronized between both phases.
If we imagine that this common logic would be stored in different repositories or handled by different
development teams, then <strong>Option 2.</strong> would be preferable.</p>
<h2 id="job-implementation">Job Implementation</h2>
<h3 id="feature-extraction">Feature Extraction</h3>
<p>This part we will implement in Flink ML and reuse some parts of the code from the first blog post about Flink ML.</p>
<pre data-lang="scala" style="background-color:#2e3440;color:#d8dee9;" class="language-scala "><code class="language-scala" data-lang="scala"><span style="color:#81a1c1;">val schema = </span><span style="color:#8fbcbb;">Schema
</span><span>  </span><span style="color:#81a1c1;">.</span><span>newBuilder()
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;RowNumber&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">INT</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;CustomerId&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">INT</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;Surname&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">STRING</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;CreditScore&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;GeographyStr&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">STRING</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;GenderStr&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">STRING</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;Age&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;Tenure&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;Balance&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;NumOfProducts&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;HasCrCard&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;IsActiveMember&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;EstimatedSalary&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>column(</span><span style="color:#a3be8c;">&quot;Exited&quot;</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">DOUBLE</span><span>())
</span><span>  </span><span style="color:#81a1c1;">.</span><span>build()
</span><span>
</span><span style="color:#616e88;">// 1 - Index Categorical columns
</span><span style="color:#81a1c1;">val indexer = </span><span style="color:#8fbcbb;">StringIndexer</span><span>()
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setStringOrderType(</span><span style="color:#8fbcbb;">StringIndexerParams</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">ALPHABET_ASC_ORDER</span><span>)
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setInputCols(</span><span style="color:#a3be8c;">&quot;GeographyStr&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;GenderStr&quot;</span><span>)
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setOutputCols(</span><span style="color:#a3be8c;">&quot;GeographyInd&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;Gender&quot;</span><span>)
</span><span>
</span><span style="color:#616e88;">// 2 - Encode Geography column
</span><span style="color:#81a1c1;">val geographyEncoder =
</span><span>  </span><span style="color:#8fbcbb;">OneHotEncoder</span><span>()
</span><span>    </span><span style="color:#81a1c1;">.</span><span>setInputCols(</span><span style="color:#a3be8c;">&quot;GeographyInd&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>setOutputCols(</span><span style="color:#a3be8c;">&quot;Geography&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>setDropLast(</span><span style="color:#81a1c1;">false</span><span>)
</span><span>
</span><span style="color:#616e88;">// 3 - Merge to Vector
</span><span style="color:#81a1c1;">val continuesCols = </span><span style="color:#8fbcbb;">List</span><span>(
</span><span>  </span><span style="color:#a3be8c;">&quot;CreditScore&quot;</span><span style="color:#eceff4;">,
</span><span>  </span><span style="color:#a3be8c;">&quot;Age&quot;</span><span style="color:#eceff4;">,
</span><span>  </span><span style="color:#a3be8c;">&quot;Tenure&quot;</span><span style="color:#eceff4;">,
</span><span>  </span><span style="color:#a3be8c;">&quot;Balance&quot;</span><span style="color:#eceff4;">,
</span><span>  </span><span style="color:#a3be8c;">&quot;NumOfProducts&quot;</span><span style="color:#eceff4;">,
</span><span>  </span><span style="color:#a3be8c;">&quot;EstimatedSalary&quot;
</span><span>)
</span><span style="color:#81a1c1;">val categoricalCols = </span><span style="color:#8fbcbb;">List</span><span>(</span><span style="color:#a3be8c;">&quot;Geography&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;Gender&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;HasCrCard&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;IsActiveMember&quot;</span><span>)
</span><span style="color:#616e88;">// Geography is 3 countries + other features
</span><span style="color:#81a1c1;">val encodedFeatures = </span><span style="color:#8fbcbb;">List</span><span>(</span><span style="color:#b48ead;">3</span><span>)
</span><span style="color:#81a1c1;">val vectorSizes =
</span><span>  encodedFeatures ++ </span><span style="color:#8fbcbb;">List</span><span style="color:#81a1c1;">.</span><span>fill(
</span><span>   categoricalCols</span><span style="color:#81a1c1;">.</span><span>length - encodedFeatures</span><span style="color:#81a1c1;">.</span><span>length + continuesCols</span><span style="color:#81a1c1;">.</span><span>length
</span><span>  )(</span><span style="color:#b48ead;">1</span><span>)
</span><span>
</span><span style="color:#81a1c1;">val assembler = </span><span style="color:#8fbcbb;">VectorAssembler</span><span>()
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setInputCols((categoricalCols ++ continuesCols)*)
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setOutputCol(</span><span style="color:#a3be8c;">&quot;combined_features&quot;</span><span>)
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setInputSizes(vectorSizes</span><span style="color:#81a1c1;">.</span><span>map(</span><span style="color:#8fbcbb;">Integer</span><span style="color:#81a1c1;">.</span><span>valueOf)*)
</span><span>
</span><span style="color:#616e88;">// 4 - Normalize numbers
</span><span style="color:#81a1c1;">val featuresCol = </span><span style="color:#a3be8c;">&quot;features&quot;
</span><span style="color:#81a1c1;">val standardScaler = </span><span style="color:#8fbcbb;">StandardScaler</span><span>()
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setWithMean(</span><span style="color:#81a1c1;">true</span><span>)
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setInputCol(</span><span style="color:#a3be8c;">&quot;combined_features&quot;</span><span>)
</span><span>  </span><span style="color:#81a1c1;">.</span><span>setOutputCol(featuresCol)
</span><span>
</span><span style="color:#81a1c1;">val trainData =</span><span> tEnv</span><span style="color:#81a1c1;">.</span><span>from(
</span><span>  </span><span style="color:#8fbcbb;">TableDescriptor
</span><span>    </span><span style="color:#81a1c1;">.</span><span>forConnector(</span><span style="color:#a3be8c;">&quot;filesystem&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>schema(schema)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;path&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;... path to train data file&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;format&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;csv&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;csv.allow-comments&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;true&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>build()
</span><span>  )
</span><span>
</span><span style="color:#81a1c1;">val stages = </span><span style="color:#8fbcbb;">List</span><span>[</span><span style="color:#8fbcbb;">Stage</span><span>[</span><span style="color:#81a1c1;">?</span><span>]](
</span><span>  indexer</span><span style="color:#eceff4;">,
</span><span>  geographyEncoder</span><span style="color:#eceff4;">,
</span><span>  assembler</span><span style="color:#eceff4;">,
</span><span>  standardScaler
</span><span>)</span><span style="color:#81a1c1;">.</span><span>asJava
</span><span>
</span><span style="color:#81a1c1;">val pipeline = </span><span style="color:#8fbcbb;">Pipeline</span><span>(stages)
</span><span style="color:#81a1c1;">val featureExtractor =</span><span> pipeline</span><span style="color:#81a1c1;">.</span><span>fit(trainData)  
</span></code></pre>
<p>Above we define a schema of CSV file which will be used to train feature extractors such as encoder and scaler.
This extra-training is going to be done only once on the job start time. For the faster start up we can also save the <code>featureExtractor</code> state
on disk and load it on job start instead of training it every time.</p>
<h3 id=""></h3>
<h3 id="working-with-onnx-model">Working with ONNX model</h3>
<p>In order to load and call ONNX model in JVM we will use <a href="https://onnxruntime.ai/">ONNX Runtime</a> library inside our Flink job:</p>
<pre style="background-color:#2e3440;color:#d8dee9;"><code><span>&quot;com.microsoft.onnxruntime&quot; % &quot;onnxruntime&quot; % &quot;1.19.2&quot;
</span></code></pre>
<p>The model inference is wrapped into the Flink RichMapFunction:</p>
<pre data-lang="scala" style="background-color:#2e3440;color:#d8dee9;" class="language-scala "><code class="language-scala" data-lang="scala"><span style="color:#81a1c1;">case class</span><span style="color:#8fbcbb;"> ChurnPrediction</span><span>(raw: </span><span style="color:#81a1c1;">Float</span><span style="color:#eceff4;">, </span><span>exited: </span><span style="color:#81a1c1;">Boolean</span><span>)
</span><span>
</span><span style="color:#81a1c1;">class</span><span style="color:#8fbcbb;"> CustomerChurnClassifier</span><span>(modelPath: </span><span style="color:#8fbcbb;">String</span><span style="color:#eceff4;">, </span><span>vectorSize: </span><span style="color:#81a1c1;">Int</span><span>)
</span><span>    extends </span><span style="color:#8fbcbb;">RichMapFunction</span><span>[</span><span style="color:#8fbcbb;">Array</span><span>[</span><span style="color:#81a1c1;">Float</span><span>]</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">ChurnPrediction</span><span>]:
</span><span>
</span><span>  </span><span style="color:#81a1c1;">private val shape = </span><span style="color:#8fbcbb;">Array</span><span>(</span><span style="color:#b48ead;">1</span><span style="color:#81a1c1;">L</span><span style="color:#eceff4;">,</span><span> vectorSize)
</span><span>  @transient </span><span style="color:#81a1c1;">var </span><span>env: </span><span style="color:#8fbcbb;">OrtEnvironment </span><span style="color:#81a1c1;">= _
</span><span>  @transient </span><span style="color:#81a1c1;">var </span><span>session: </span><span style="color:#8fbcbb;">OrtSession </span><span style="color:#81a1c1;">= _
</span><span>
</span><span>  </span><span style="color:#81a1c1;">override def </span><span style="color:#88c0d0;">open</span><span>(parameters: </span><span style="color:#8fbcbb;">Configuration</span><span>): </span><span style="color:#81a1c1;">Unit =
</span><span>    env </span><span style="color:#81a1c1;">= </span><span style="color:#8fbcbb;">OrtEnvironment</span><span style="color:#81a1c1;">.</span><span>getEnvironment()
</span><span>    session </span><span style="color:#81a1c1;">=</span><span> env</span><span style="color:#81a1c1;">.</span><span>createSession(modelPath</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">OrtSession</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">SessionOptions</span><span>())
</span><span>
</span><span>  </span><span style="color:#81a1c1;">override def </span><span style="color:#88c0d0;">map</span><span>(features: </span><span style="color:#8fbcbb;">Array</span><span>[</span><span style="color:#81a1c1;">Float</span><span>]): </span><span style="color:#8fbcbb;">ChurnPrediction </span><span style="color:#81a1c1;">=
</span><span>    </span><span style="color:#81a1c1;">var </span><span>tensor </span><span style="color:#81a1c1;">= </span><span style="color:#8fbcbb;">OnnxTensor</span><span style="color:#81a1c1;">.</span><span>createTensor(env</span><span style="color:#eceff4;">, </span><span style="color:#8fbcbb;">FloatBuffer</span><span style="color:#81a1c1;">.</span><span>wrap(features)</span><span style="color:#eceff4;">,</span><span> shape)
</span><span>    </span><span style="color:#81a1c1;">val inputs = </span><span style="color:#8fbcbb;">Map</span><span>(</span><span style="color:#a3be8c;">&quot;dense_input&quot;</span><span> -&gt; tensor)</span><span style="color:#81a1c1;">.</span><span>asJava
</span><span>
</span><span>    </span><span style="color:#81a1c1;">val predicted = </span><span style="color:#8fbcbb;">Using</span><span style="color:#81a1c1;">.</span><span>resource(session</span><span style="color:#81a1c1;">.</span><span>run(inputs)) { outputs </span><span style="color:#81a1c1;">=&gt;
</span><span>      </span><span style="color:#81a1c1;">val out =</span><span> outputs</span><span style="color:#81a1c1;">.</span><span>iterator()</span><span style="color:#81a1c1;">.</span><span>asScala</span><span style="color:#81a1c1;">.</span><span>toList</span><span style="color:#81a1c1;">.</span><span>head
</span><span>      out</span><span style="color:#81a1c1;">.</span><span>getValue</span><span style="color:#81a1c1;">.</span><span>asInstanceOf[</span><span style="color:#8fbcbb;">OnnxTensor</span><span>]</span><span style="color:#81a1c1;">.</span><span>getFloatBuffer</span><span style="color:#81a1c1;">.</span><span>array()
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbcbb;">ChurnPrediction</span><span>(predicted</span><span style="color:#81a1c1;">.</span><span>head</span><span style="color:#eceff4;">,</span><span> predicted</span><span style="color:#81a1c1;">.</span><span>head &gt; </span><span style="color:#b48ead;">0</span><span style="color:#eceff4;">.</span><span style="color:#b48ead;">5</span><span>)
</span></code></pre>
<p>MapFunction loads model in memory and creates a session object to be able to run model inference in <code>map</code> method on every input event.
The <code>features</code> parameter represents a feature vector of the source record.</p>
<h3 id="live-data">Live Data</h3>
<p>As live data we will use just a sample of CSV data taken from the initial CSV file. However, the source type can be in any other form including Kafka, JDBC or other file formats.
Inference job also does not care if this job graph will be executed in streaming or batch mode, so we can decide any time whether this job needs to be continuously running or
just applied for a prepared data set in batch mode.</p>
<pre data-lang="scala" style="background-color:#2e3440;color:#d8dee9;" class="language-scala "><code class="language-scala" data-lang="scala"><span style="color:#81a1c1;">val testData =</span><span> tEnv</span><span style="color:#81a1c1;">.</span><span>from(
</span><span>  </span><span style="color:#8fbcbb;">TableDescriptor
</span><span>    </span><span style="color:#81a1c1;">.</span><span>forConnector(</span><span style="color:#a3be8c;">&quot;filesystem&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>schema(
</span><span>    </span><span style="color:#8fbcbb;">Schema
</span><span>      </span><span style="color:#81a1c1;">.</span><span>newBuilder()
</span><span>      </span><span style="color:#81a1c1;">.</span><span>fromColumns(
</span><span>        </span><span style="color:#616e88;">// remove label column
</span><span>        schema</span><span style="color:#81a1c1;">.</span><span>getColumns()</span><span style="color:#81a1c1;">.</span><span>asScala</span><span style="color:#81a1c1;">.</span><span>dropRight(</span><span style="color:#b48ead;">1</span><span>)</span><span style="color:#81a1c1;">.</span><span>asJava
</span><span>      )
</span><span>      </span><span style="color:#81a1c1;">.</span><span>build()
</span><span>    )
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;path&quot;</span><span style="color:#eceff4;">,</span><span> testDataPath)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;format&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;csv&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;csv.allow-comments&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;true&quot;</span><span>)
</span><span>    </span><span style="color:#616e88;">// monitor-interval makes CSV source to run in streaming mode
</span><span>    </span><span style="color:#81a1c1;">.</span><span>option(</span><span style="color:#a3be8c;">&quot;source.monitor-interval&quot;</span><span style="color:#eceff4;">, </span><span style="color:#a3be8c;">&quot;3s&quot;</span><span>)
</span><span>    </span><span style="color:#81a1c1;">.</span><span>build()
</span><span>)
</span><span>
</span><span style="color:#81a1c1;">val transformed =</span><span> featureExtractor</span><span style="color:#81a1c1;">.</span><span>transform(testData)</span><span style="color:#81a1c1;">.</span><span>head
</span></code></pre>
<h3 id="job-graph-execution">Job Graph Execution</h3>
<p>Now we are ready to stitch all pieces together and execute the Flink job graph:</p>
<pre data-lang="scala" style="background-color:#2e3440;color:#d8dee9;" class="language-scala "><code class="language-scala" data-lang="scala"><span style="color:#81a1c1;">val features =</span><span> transformed
</span><span>  </span><span style="color:#81a1c1;">.</span><span>select(
</span><span>    vectorToArray($(featuresCol))
</span><span>    </span><span style="color:#81a1c1;">.</span><span>cast(</span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">ARRAY</span><span>(</span><span style="color:#8fbcbb;">DataTypes</span><span style="color:#81a1c1;">.</span><span style="color:#8fbcbb;">FLOAT</span><span>()))
</span><span>  )
</span><span>
</span><span style="color:#81a1c1;">def </span><span style="color:#88c0d0;">toArray</span><span>[</span><span style="color:#8fbcbb;">T</span><span style="color:#81a1c1;">: </span><span style="color:#8fbcbb;">ClassTag</span><span>](r: </span><span style="color:#8fbcbb;">Row</span><span>): </span><span style="color:#8fbcbb;">Array</span><span>[</span><span style="color:#8fbcbb;">T</span><span>] </span><span style="color:#81a1c1;">=
</span><span>  </span><span style="color:#81a1c1;">try</span><span> r</span><span style="color:#81a1c1;">.</span><span>getFieldAs[</span><span style="color:#8fbcbb;">Array</span><span>[</span><span style="color:#81a1c1;">?</span><span>]](</span><span style="color:#b48ead;">0</span><span>)</span><span style="color:#81a1c1;">.</span><span>map(</span><span style="color:#81a1c1;">_.</span><span>asInstanceOf[</span><span style="color:#8fbcbb;">T</span><span>])
</span><span>  </span><span style="color:#81a1c1;">catch
</span><span>    </span><span style="color:#81a1c1;">case </span><span>e </span><span style="color:#81a1c1;">=&gt;      
</span><span>      </span><span style="color:#81a1c1;">throw </span><span style="color:#8fbcbb;">RuntimeException</span><span>(</span><span style="color:#88c0d0;">s</span><span style="color:#a3be8c;">&quot;</span><span>Failed to parse field at row(0): $r</span><span style="color:#a3be8c;">&quot;</span><span style="color:#eceff4;">,</span><span> e)
</span><span>
</span><span style="color:#8fbcbb;">DataStream</span><span>(tEnv</span><span style="color:#81a1c1;">.</span><span>toDataStream(features))
</span><span>  </span><span style="color:#81a1c1;">.</span><span>map(toArray[</span><span style="color:#81a1c1;">Float</span><span>])
</span><span>  </span><span style="color:#81a1c1;">.</span><span>map(</span><span style="color:#8fbcbb;">CustomerChurnClassifier</span><span>(</span><span style="color:#a3be8c;">&quot;&lt;path the ONNX file...&gt;&quot;</span><span style="color:#eceff4;">,</span><span> vectorSizes</span><span style="color:#81a1c1;">.</span><span>sum))
</span><span>  </span><span style="color:#81a1c1;">.</span><span>print()
</span><span>
</span><span>env</span><span style="color:#81a1c1;">.</span><span>execute(</span><span style="color:#a3be8c;">&quot;CustomerChurnAnalysis&quot;</span><span>)
</span></code></pre>
<p>Job graph combines together Table API source table and DataStream map functions.
In the first <code>map</code> we cast table row to the appropriate input of the <code>CustomerChurnClassifier</code>. The last one runs the model inference and prints the prediction result into the
console. That row casting is unfortunate price from using Table API and crossing the boundaries to use the DataStream API further. Alternatively we could try
to implement inference logic using Table API as User-Defined-Function (UDF).</p>
<p>

<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;overall-jobgraph.c07181570ae3a0e4.png" class="center-image"/>
<br/><br/>


<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;job-state-tasks.21038857cd4bdda6.png" class="center-image"/>
<br/><br/></p>
<p align="center">Figure 4. Overall Flink job graph</p>


<img src="https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;processed_images&#x2F;job-graph-inference-part.80031d433ce2535f.png" class="center-image"/>
<br/><br/><p align="center">Figure 5. Bottom part of the Flink job graph with focus on inference</p>
<p>Above Flink job graph shows quite a lot tasks. This is because the feature extraction is done with Flink ML which schedules every internal operation as a task.
This is quite useful when we deal with a lot data, so that we can process it very fast. The are 6 tasks running highlighted in the red shape.
They are responsible for the model inference. All other 21 tasks on top are Flink ML tasks are scheduled for training of the feature extraction operators.
These tasks transition to <code>finished</code> state quite fast, as encoders gets trained within 10 seconds based on the training data set of 10k rows we used.</p>
<p>The entire code of the Flink job using ONNX format model is published in Git repository:
<a href="https://github.com/novakov-alexey/flink-onnx">flink-onnx</a></p>
<h1 id="summary">Summary</h1>
<p>As Flink Developers, we can easily embed ML models into our Flink jobs in format like ONNX.
This allows us to train ML algorithms in any language/platform we want, including Python.
One important point to think in advance is the feature extraction.
Architects should decide how to implement feature extraction logic once and reuse it everywhere: training and inference.
Embedding ML models inside the Flink job allows us to avoid any network latency comparing with alternative approach when an ML model is served as a service via HTTP/RPC API.</p>

          </div>
          <div class="container has-text-centered">
            
  <p class="is-size-5">
    Share:
    <a class="link" data-sharer="facebook" data-url='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;flink-model-formats&#x2F;' href="javascript:void(0);" title="Share on facebook">
      <span class="icon">
        <i class="fab fa-facebook-square"></i>
      </span>
    </a>
    <a class="link" data-sharer="twitter" data-title='ONNX Model format in Flink ' data-url='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;flink-model-formats&#x2F;' href="javascript:void(0);" title="Share on twitter">
      <span class="icon">
        <i class="fab fa-twitter"></i>
      </span>
    </a>
    <a class="link" data-sharer="linkedin" data-url='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;flink-model-formats&#x2F;' href="javascript:void(0);" title="Share on linkedin">
      <span class="icon">
        <i class="fab fa-linkedin"></i>
      </span>
    </a>
    <a class="link" data-sharer="reddit" data-url='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;flink-model-formats&#x2F;' href="javascript:void(0);" title="Share on reddit">
      <span class="icon">
        <i class="fab fa-reddit"></i>
      </span>
    </a>
    <a class="link" data-sharer="hackernews" data-title="ONNX Model format in Flink " data-url='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;flink-model-formats&#x2F;' href="javascript:void(0);" title="Share on hackernews">
      <span class="icon">
        <i class="fab fa-hacker-news"></i>
      </span>
    </a>
    <a class="link" data-sharer="whatsapp" data-title="ONNX Model format in Flink " data-url='https:&#x2F;&#x2F;novakov-alexey.github.io&#x2F;flink-model-formats&#x2F;' href="javascript:void(0);" title="Share on whatsapp">
      <span class="icon">
        <i class="fab fa-whatsapp-square"></i>
      </span>
    </a>
  </p>

          </div>
        </article>
      </div>
      
      <div class="column is-2 is-hidden-mobile">
        <aside class="menu" style="position: sticky; top: 48px">
          <p class="heading has-text-weight-bold">Contents</p>
          <ul class="menu-list">
            
            <li>
              <a id="link-training-in-python" class="toc is-size-7 is-active" href="https://novakov-alexey.github.io/flink-model-formats/#training-in-python">
                Training in Python
              </a>
              
            </li>
            
            <li>
              <a id="link-inference-in-flink" class="toc is-size-7 " href="https://novakov-alexey.github.io/flink-model-formats/#inference-in-flink">
                Inference in Flink
              </a>
              
              <ul>
                
                <li>
                  <a id="link-job-implementation" class="toc is-size-7" href="https://novakov-alexey.github.io/flink-model-formats/#job-implementation">
                    Job Implementation
                  </a>
                </li>
                
              </ul>
              
            </li>
            
            <li>
              <a id="link-summary" class="toc is-size-7 " href="https://novakov-alexey.github.io/flink-model-formats/#summary">
                Summary
              </a>
              
            </li>
            
          </ul>
        </aside>
      </div>
      
    </div>
  </div>
</section>
  


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  



  
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-6">
        <div id="disqus_thread"></div>
      </div>
    </div>
  </div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    
    var disqus_config = function () {      
      this.page.url = 'https://novakov-alexey.github.io/flink-model-formats/';  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = 'flink-model-formats'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://novakov-alexey-blog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https://novakov-alexey.github.io/search_index.en.js'></script>
  <script src='https://novakov-alexey.github.io/js/site.js'></script>

  

<script type="text/javascript">
  const menuBarHeight = $("nav.navbar").height();
  const tocItems = $('.toc');
  const navSections = new Array($('.toc').length);

  tocItems.each(function (i) {
    let id = $(this).attr("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex+1] : $("section.section").get(1);
    
    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (c.top + (n.top - c.top) - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);
</script>




</body>

</html>